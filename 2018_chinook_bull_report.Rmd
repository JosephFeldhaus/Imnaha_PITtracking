---
title: "2018 Imnaha River Chinook Salmon and Bull Trout summaries"
author: "Joseph Feldhaus (ODFW) & Ryan Kinzer (NPT)"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
### Noteable Highlights/Data issues
* Imnaha Weir installation date: **11 June, 2018**.
    + A staff injury on June 11th precluded the ladder from being watered to allow fish passage.
    + The ladder was potentially watered either Tuesday the 12th or Wednesday the 13th. **(check with weir staff)**
  
* On June 11th, 2018 we discoved that IR5 had not been uploading tag detections to PTAGIS since 5/26. Joseph contacted BioMark staff to help diagnose and fix the problem.  All other tag detection sites were working correctly (e.g. IR4 & IML).
    + Last tag detected before IR5 went offline was on May 25th at 3:14 a.m.
    + IR5 was brought back online on June 13th and almost immediately started detecting Bull trout tags at 1:10 p.m.
    + The cause of the downtime was attributed to a faulty master controller.


 

```{r setup, echo = FALSE, include = FALSE}
library(knitr)
library(pander)
library(tidyverse)
library(lubridate)
library(scales)
library(PITcleanr)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error = TRUE)

panderOptions('round',2)
```


```{r load_data}
# Un-comment out the source code to update the data
#source("./R/02_load_chinook_bull_data.R")

df<-readRDS("./data/PITcleanr_2018_chs_bull.rds")
load("./data/config_data_20180605.rda")

```

### Unique PIT-tag observations by species
```{r }
df %>%
  group_by(Mark.Species, Origin) %>%
  summarise(Unique_Tags = n_distinct(TagID)) %>%
  pander()
```


### Unique PIT-tag observations by speices, origin and release site
```{r }
df %>%
  mutate(Release.Year = year(Release.Date)) %>%
  group_by(Mark.Species, Origin, Release.Site.Code) %>%
  summarise(Unique_Tags = n_distinct(TagID)) %>%
  pander()
```

### Unique PIT-tag observations by species, origin and arrival date

Do we want to truncate the dates for Bull trout observations?

```{r Unique Tag counts}

df %>%
  filter(!SiteID%in%c("BSC","COC")) %>%
  group_by(TagID, Mark.Species, Origin, Release.Site.Code, SiteID) %>%
  slice(which.min(lastObsDateTime)) %>%
  ggplot(aes(x=lastObsDateTime, fill=Origin)) +
  geom_histogram(bins = 100) +
  facet_grid(factor(SiteID,levels=c("IR1","IR2","IR3","IR4","IML","IR5"))~Mark.Species,scales="free_y") +
  theme_bw() +
  theme(panel.grid.major=element_blank())+
  labs(x = "First detection date",
       y = "Count")
```

### Unique PIT-tag observations by site, detection efficiencies and estimated tags

```{r efficiency}
tmp_df <- df %>%
  mutate(Node = gsub("A0", "B0", Node))  # calculates efficiency at the site level

tmp_df %>%
  filter(!Node%in%c("COCA0","COCB0","BSCA0","BSCB0", "IMNAHR")) %>%
  mutate(Obs_location = ifelse(grepl("IR", Node), "Instream", "Ladder-Trap")) %>%
  group_by(Mark.Species, Obs_location) %>%
  do(nodeEfficiency(.,direction="Upstream")) %>%
  arrange(Mark.Species, NodeOrder) %>%
  mutate(det_eff = ifelse(Node != 'IMNAHW', Recaps/Marks, 1.00),
         se_eff = (1/Marks^2)*(Marks*det_eff)*(1-det_eff),
         N_tags = Unique_tags/det_eff,
         se_N = sqrt(((Marks+1)*(Unique_tags+1)*(Marks - Recaps) * (Unique_tags - Recaps))/ ((Recaps+1)^2 * (Recaps+2))),
         lwr_N = N_tags - 1.96*se_N,
         upr_N = N_tags + 1.96*se_N,
         N_up = lag(N_tags),
         Conversion = paste0(round(N_tags/N_up*100),"%"),
         Node = gsub("B0", "", Node)) %>%
  ungroup() %>%
  select(Mark.Species, SiteID = Node, Unique_Tags = Unique_tags, det_eff, N_tags, lwr_N, upr_N, Conversion) %>%
  pander()
```


```{r detect_hist}
# this should be part of the load file and read-in!!!!!!!!
# We should add a field for TrapStatus - will help for summarization and grouping later
# need another field for passage route - use TagPath for ifelse (if IR5 was it IMNAHW = Handled); (if IR5 was it IML = Ladder Attempt ); if (IR5 was it IR4 = No Ladder Attempt)
# might need to consider fish going downstream
detect_hist <- df %>%
  filter(!SiteID %in% c('COC', 'BSC')) %>%
  select(TagID, Mark.Species, Origin, lastObsDateTime, SiteID) %>%
  mutate(SiteID = factor(SiteID,levels=c("IR1","IR2","IR3","IR4","IML","IR5"))) %>%
  group_by(TagID, SiteID) %>%
  slice(which.min(lastObsDateTime)) %>%
  spread(SiteID, lastObsDateTime) %>%
  left_join(df %>%
            mutate(UserProcStatus = AutoProcStatus) %>%
            rename(ObsDate = firstObsDateTime, lastObsDate = lastObsDateTime) %>%
            estimateSpawnLoc(), by = 'TagID') %>%
  mutate(TagStatus = ifelse(AssignSpawnSite=="IR4" & LastObs <= ymd(20180611), "Assummed Passed Prior Weir",
                          ifelse(grepl("IR5", TagPath), "Successfully Passed",
                                ifelse(grepl("IMNAHW", TagPath) & grepl("IR4", TagPath), "Successfully Trapped",
                                   ifelse(grepl("IML", TagPath) & grepl("IR4", TagPath), "Attemptting Ladder",
                                      ifelse(grepl("IR4", TagPath), "At Weir",paste0("Last Seen at ",AssignSpawnSite))))))) 
  #select(TagID, Mark.Species, Origin, LastObs, AssignSpawnSite, AssignSpawnNode, TagPath, IR1:IR5)
```


### Unique PIT-tag observations by fate
```{r}
detect_hist %>%
  group_by(Mark.Species, Origin, TagFate) %>%
  summarise(Unique_Tags = n()) %>%
  pander()
```


## Travel time between sites

```{r Travel Time}
detect_hist %>%
  mutate(IR1_IR2 = difftime(IR2, IR1, units = 'days'),  # move up to detect_hist
         IR2_IR3 = difftime(IR3, IR2, units = 'days'),
         IR3_IR4 = difftime(IR4, IR3, units = 'days'),
         IR4_IR5 = difftime(IR5, IR4, units = 'days')) %>%
  select(TagID, Mark.Species, Origin, IR1_IR2:IR4_IR5) %>%
  mutate_at(c(4:7), as.numeric) %>%
  gather(Reach, Travel_Time, IR1_IR2:IR4_IR5) %>%
  filter(Travel_Time >= 0) %>%
  ggplot(aes(x = Travel_Time, fill = Origin)) +
  geom_histogram(colour = 'black', alpha = .5, bins = 20) +
  scale_fill_brewer(palette = 'Set1') +
  facet_grid(Reach ~ Mark.Species) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = 'Travel Time (Days)',
       y = 'Count') 
```


## Number of days spent at a site
```{r days_site}
# number of days at a site
df %>%
  filter(!SiteID %in% c('COC','BSC')) %>%
  mutate(SiteID = factor(SiteID,levels=c("IR1","IR2","IR3","IR4","IML","IR5"))) %>%
  group_by(Mark.Species, Origin, SiteID, TagID) %>%
  summarise(minObsDate = min(lastObsDateTime),
          maxObsDate = max(lastObsDateTime),
          hours = difftime(maxObsDate, minObsDate, units = 'days')) %>%
  ggplot(aes(x = hours, fill = Origin)) +
  geom_histogram(colour = 'black', alpha = .5, bins = 20) +
  scale_fill_brewer(palette = 'Set1') +
  facet_grid(SiteID ~ Mark.Species) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = 'Days (max(obsDate) - min(obsDate))',
       y = 'Count') 
```


### Source Data
The complete PIT-tag histories for Chinook Salmon and Bull trout detected during 2018 in the Imnaha River Basin were downloaded as two seperate files located on the [PTAGIS ftp server](ftp://ftp.ptagis.org/MicroStrategyExport/). The files are the result of running "Complete Tag History" queries that were parameterized on the [PTAGIS website](https://www.ptagis.org/) and set-up to run and save automatically at 6:00 a.m. each day.  The first file contains Chinook Salmon PIT-tag detections and is stored at the "*feldhauh/2018_Imnaha_CompleteTagHistory.csv*" file path within the ftp server.  The second file contains Bull trout detections and is stored within the "*rkinzer/Imnaha_Bull_Complete_Tag_History.csv*" filepath.  We are then using an R-script to download the files from the PTAGIS ftp server and combine them into a single file.  Once the file is combined all Chinook Salmon and Bull trout tag detections are processed using the R package [PITcleanR](https://github.com/kevinsee/PITcleanR). The final dataset provides a simplified tag history with the first and last detection dates at each PIT-tag detection node (i.e., a single spanning array or antenna) and information regarding upstream and downstream movements and a more general migration direction.   

#####*Creating the PTAGIS Chinook Complete Tag History report:*  
* *Tag list #1:* Static Tag list for all Chinook tagged in 2018 and released at BONAFF or LGRLDR.  
* *Tag list #2:* Static Tag list for Chinook released into the Imnaha River for MY2015-2017 and detected at a mainstem adult ladder interrogatoin site in 2018.  
* *Event Date:* Between 5/1/2018 and 10/1/2018
* *Event Sites:* IR1, IR2, IR3, IR4, IR5, IML, IMNAHW, BSC, IMNAHR
* *Mark Species:* Chinook
* *Event Type:* Observation, Recapture, Recovery

#####*Creating the PTAGIS Bull Trout Complete Tag History report:*  
* *Query:* All PIT-tagged Bull trout detected in the Imnaha River Basin in 2018.   
* *Event Date:* Between 1/1/2018 and 10/1/2018
* *Event Sites:* IR1, IR2, IR3, IR4, IR5, IML, IMNAHW, COC, BSC, IMNAHR
* *Mark Species:* Bull Trout
* *Event Type:* Observation, Recapture, Recovery 
